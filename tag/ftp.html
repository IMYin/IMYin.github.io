<!DOCTYPE html>
<html lang="zh" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>ftp - Yin's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




    <meta name="author" content="Yin" />
    <meta name="keywords" content="ftp" />

    <!-- Open Graph tags -->
        <meta property="og:site_name" content="Yin's Blog" />
        <meta property="og:type" content="website"/>
        <meta property="og:title" content="Yin's Blog"/>
        <meta property="og:url" content="https://IMYin.github.io"/>
        <meta property="og:description" content="Yin's Blog"/>


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://IMYin.github.io/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://IMYin.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://IMYin.github.io/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://IMYin.github.io/theme/css/style.css" type="text/css"/>

        <link href="https://IMYin.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Yin's Blog ATOM Feed"/>




</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://IMYin.github.io/" class="navbar-brand">
Yin's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/archives.html">Archives</a></li>
                         <li><a href="https://IMYin.github.io/pages/about-me.html">
                             About Me
                          </a></li>
                        <li >
                            <a href="https://IMYin.github.io/category/ji-zhu-wen-zhang.html">技术文章</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <article>
                <h2><a href="https://IMYin.github.io/2016/10/20/ftp2hive/">FTP数据入库Hive(shell实现)</a></h2>
                <div class="summary">
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>今天聊一聊我们公司辽宁项目中是怎样做数据处理的。
先来看一下处理数据的架构，非常之简单：</p>
<p>当然今天不是来讲架构的，而想记录一下我之前用shell写的数据处理脚本。</p>
<p>先简单说一下我们这个loooooooooow架构：</p>
<center>FTP共享平台</center>
<center>$\Downarrow$</center>
<center>4台交换机</center>
<center>$\Downarrow$</center>
<center>17台规模的Hadoop集群</center><p>其中交换机与FTP共享平台之间是用的万兆光纤传输，每个文件有380m左右大小，每小时有将近200个文件需要处理，也就是一天大概处理1.8T的数据量，需要插入10张表中。 
为了实现在处理数据时可以并发处理，我针对每一张表都写了两个脚本，其中一个放在交换机中，另一个放在Hadoop集群中（最好放在Datanode节点中）。 
代码如下：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<pre><code>#/bin/bash

#This script will deal with the dns_data.

LOGIN_FTP_USER=$1
LOGIN_FTP_PASSWD=$2
REMOTE_DIR=/home/sunnyin/test/longName   #test dir
LOCAL_DIR=$3   #test dir  /home/hadoop/test_818/dataxx
FTP_HOST=$4
TIME_NOW=$5
length_p5=`echo ${TIME_NOW}|wc -L`
data_dir=$LOCAL_DIR/dns/$TIME_NOW  #接口路径

#check the parameter
if [ -z ${TIME_NOW} ]; then
TIME_NOW=`date +%Y%m%d%H`
echo "Will get data of $TIME_NOW...."
elif [ ${length_p5} -ne 10 ];then
echo "The parameter 5 is wrong,please check and run again..."
exit 1
else
echo "Will get data of $TIME_NOW...."
fi

#make dir and change dir
if [ -d ${data_dir} ]; then
cd ${data_dir}
else
echo "The dictionary is not exist,will create..."
mkdir -p ${data_dir}
cd ${data_dir}
fi

#login ftp
for (( i=0;i<=15;i++))
do
if [ $i -lt 10 ];then
j=`printf "%02d" "$i"`
else
j=$i
fi
ftp -n&lt;&lt;!
open ${FTP_HOST}
user ${LOGIN_FTP_USER} ${LOGIN_FTP_PASSWD}
cd ${REMOTE_DIR}/dns
prompt
mget *${TIME_NOW}${j}*
close
bye
!
done
if [ $? -eq 0 ]; then
echo "Files transfer is completed...(0~15 minutes data)"
else
echo "File transfer failed"
exit 1
fi

#make a tuple(files name)
files=(`ls $data_dir`)
TABLE_NAME_TIME=(`ls $data_dir|awk -F _ '{print $2}'`)  #time:YYYYMMHHMMSS

#split
for file in ${files[@]}
do
split -C 128m $file -d -a 3 $TABLE_NAME_TIME
if [ $? -eq 0 ]; then
echo "Split ${file} completed..."
else
echo -e "Split ${file} failed!!\nPlease check the file:${file}"
continue
fi
done

#compress
cd $data_dir
gzip dns*
if [ $? -eq 0 ]; then
echo "Compress files completed..."
else
echo "Comgress files failed!!"
exit 1
fi

echo "Transmitting file to cluster......"
scp -r $data_dir/*.gz hadoop@host.of.cluster:/home/hadoop/data_dir/dns/$TIME_NOW
echo "End of transmission......"
ssh hadoop@host.of.cluster sh load_hive_dns.sh
echo "Load data to hive database......."</code>
                    <a class="btn btn-default btn-xs" href="https://IMYin.github.io/2016/10/20/ftp2hive/">more ...</a>
                </div>
            </article>
            <hr/>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 Yin
            &middot; Powered by <a href="" target="_blank">Yin</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://IMYin.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://IMYin.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://IMYin.github.io/theme/js/respond.min.js"></script>

    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-86179791-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>